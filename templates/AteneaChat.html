<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atenea - {{ usuario }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}" id="favicon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #212121;
            color: #ececec;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: #171717;
            border-right: 1px solid #2f2f2f;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #2f2f2f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .new-chat-btn {
            background: transparent;
            border: 1px solid #2f2f2f;
            color: #ececec;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
        }

        .new-chat-btn:hover {
            background-color: #2f2f2f;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            color: #ececec;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .chat-item:hover {
            background-color: #2f2f2f;
        }

        .chat-item.active {
            background-color: #2f2f2f;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #2f2f2f;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-menu:hover {
            background-color: #2f2f2f;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            color: #8e8ea0;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #212121;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2f2f2f;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #ececec;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            background: transparent;
            border: none;
            color: #8e8ea0;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background-color: #2f2f2f;
            color: #ececec;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            background: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            font-size: 32px;
            color: white;
            overflow: hidden;
            padding: 15px;
        }

        .welcome-icon img {
            border-radius: 50%;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #ececec;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #8e8ea0;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            width: 100%;
            max-width: 800px;
        }

        .suggestion-card {
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-card:hover {
            background-color: #3f3f3f;
            border-color: #4FC3F7;
        }

        .suggestion-icon {
            font-size: 20px;
            color: #4FC3F7;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #ececec;
        }

        .suggestion-desc {
            font-size: 14px;
            color: #8e8ea0;
            line-height: 1.4;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #000000;
            color: white;
            overflow: hidden;
            padding: 3px;
        }

        .message.assistant .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }

        .message-content {
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 16px;
            max-width: 70%;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .file-attachment {
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #4FC3F7;
        }

        .file-attachment .file-icon {
            font-size: 16px;
        }

        .disclaimer {
            text-align: center;
            padding: 12px 24px 16px 24px;
            color: #8e8ea0;
            font-size: 13px;
            line-height: 1.4;
            max-width: 800px;
            margin: 0 auto;
        }

        .voice-btn {
            position: absolute !important;
            right: 60px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: transparent;
            border: none;
            color: #8e8ea0;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
            z-index: 20;
        }

        .voice-btn:hover {
            background-color: #3f3f3f;
            color: #4FC3F7;
        }

        .voice-btn.recording {
            color: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
            100% { transform: translateY(-50%) scale(1); }
        }

        .recording-indicator {
            display: none;
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ff4444;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
        }

        .recording-indicator.show {
            display: block;
        }



        .message.user .message-content {
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            border-color: #4FC3F7;
            color: white;
        }

        .message-time {
            font-size: 12px;
            color: #8e8ea0;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            max-width: 70%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #8e8ea0;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            background-color: #4a1d1d;
            border-color: #cc4444;
            color: #ff6b6b;
        }

        /* Input Area */
        .input-area {
            padding: 24px;
            border-top: 1px solid #2f2f2f;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .file-input {
            display: none;
        }

        .attach-btn {
            position: absolute !important;
            left: 12px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: transparent;
            border: none;
            color: #8e8ea0;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            z-index: 20;
        }

        .attach-btn:hover {
            background-color: #3f3f3f;
            color: #4FC3F7;
        }

        .file-preview {
            display: none;
            position: absolute;
            top: -60px;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 8px;
            font-size: 14px;
            color: #ececec;
            z-index: 10;
        }

        .file-preview.show {
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .file-preview .file-info {
            flex: 1;
        }

        .file-preview .remove-file {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        .file-preview .remove-file:hover {
            background-color: #4a1d1d;
            border-radius: 4px;
        }

        .chat-input {
            width: 100% !important;
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 16px 140px 16px 50px !important;
            color: #ececec;
            font-size: 16px;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            border-color: #4FC3F7;
        }

        .chat-input::placeholder {
            color: #8e8ea0;
        }

        .send-btn {
            position: absolute !important;
            right: 12px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            background: #4FC3F7;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            z-index: 20;
        }

        .send-btn:hover {
            background: #2196F3;
        }

        .send-btn:disabled {
            background: #3f3f3f;
            cursor: not-allowed;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 8px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(8px);
            transition: all 0.2s;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .dropdown:hover .dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-content a {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: #ececec;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: #3f3f3f;
        }

        .dropdown-content a:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-content a:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }

            .mobile-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .chat-header {
                padding-left: 60px;
            }

            .menu-toggle {
                position: absolute;
                left: 24px;
                background: transparent;
                border: none;
                color: #ececec;
                font-size: 18px;
                cursor: pointer;
            }

            .suggestions {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 24px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f3f;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>
<body>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i>
                    Nueva conversación
                </button>
            </div>
            
            <div class="chat-history">
                <div class="chat-item active">
                    <i class="fas fa-message"></i>
                    Conversación actual
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="dropdown">
                    <div class="user-menu">
                        <div class="user-avatar">{{ usuario[0].upper() }}</div>
                        <div class="user-info">
                            <div class="user-name">{{ usuario }}</div>
                            <div class="user-email">{{ email }}</div>
                        </div>
                    </div>
                    <div class="dropdown-content">
                        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title">Atenea - Asistente IA</div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Atenea Logo" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <h1 class="welcome-title">¡Hola, {{ usuario }}!</h1>
                    <p class="welcome-subtitle">
                        Soy Atenea, tu asistente de inteligencia artificial. Estoy aquí para ayudarte con preguntas generales, 
                        análisis de texto, resolución de problemas, explicaciones técnicas, y cualquier consulta que tengas. 
                        ¡Pregúntame lo que necesites!
                    </p>
                </div>
                
                <div class="messages-container" id="messagesContainer" style="display: none;">
                    <!-- Los mensajes aparecerán aquí -->
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="file-preview" id="filePreview">
                        <div class="file-info" id="fileInfo">
                            <span class="file-name"></span>
                            <span class="file-size"></span>
                        </div>
                        <button class="remove-file" onclick="removeFile()">×</button>
                    </div>


                    
                    <input type="file" id="fileInput" class="file-input" accept="image/*,.pdf,.doc,.docx,.txt,.json,.csv,.xls,.xlsx" onchange="handleFileSelect(event)">
                    
                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">
                        📋
                    </button>

                    <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()">
                        🎤
                        <div class="recording-indicator" id="recordingIndicator">Escuchando...</div>
                    </button>
                    
                    <textarea 
                        class="chat-input" 
                        placeholder="Escribe tu mensaje, adjunta un archivo o usa el micrófono"
                        rows="1"
                        onkeydown="handleKeyPress(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>

                <div class="disclaimer">
                    Atenea puede cometer errores. Considera verificar la información importante.
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://apps.alico-sa.com/webhook/6dfbf8bb-a111-43a3-a00f-1c2d6b6379a9/chat';
        let conversationId = null;
        let isWaitingForResponse = false;
        let selectedFile = null;
        
        // Variables para grabación de audio
        let mediaRecorder = null;
        let isRecording = false;
        let recordedAudio = null;
        let audioChunks = [];
        let recognition = null;
        let isTranscribing = false;

        // Funciones para manejo de archivos
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // Verificar tamaño máximo (10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    alert('El archivo es demasiado grande. El tamaño máximo permitido es 10MB.');
                    return;
                }

                selectedFile = file;
                showFilePreview(file);
            }
        }

        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const fileName = preview.querySelector('.file-name');
            const fileSize = preview.querySelector('.file-size');
            
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            
            preview.classList.add('show');
        }

        function removeFile() {
            selectedFile = null;
            const preview = document.getElementById('filePreview');
            preview.classList.remove('show');
            document.getElementById('fileInput').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Funciones para manejo de audio y transcripción
        function toggleVoiceRecording() {
            if (!isRecording) {
                startVoiceRecognition();
            } else {
                stopVoiceRecognition();
            }
        }

        function startVoiceRecognition() {
            // Verificar soporte del navegador
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Tu navegador no soporta reconocimiento de voz. Prueba con Chrome o Edge.');
                return;
            }

            try {
                // Crear instancia de reconocimiento de voz
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                // Configurar reconocimiento
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'es-ES'; // Español
                
                let finalTranscript = '';
                const input = document.querySelector('.chat-input');
                
                recognition.onstart = () => {
                    isRecording = true;
                    isTranscribing = true;
                    
                    // Actualizar UI
                    const voiceBtn = document.getElementById('voiceBtn');
                    const recordingIndicator = document.getElementById('recordingIndicator');
                    voiceBtn.classList.add('recording');
                    recordingIndicator.classList.add('show');
                    recordingIndicator.textContent = 'Escuchando...';
                };
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Mostrar transcripción en tiempo real en el input
                    input.value = finalTranscript + interimTranscript;
                    autoResize(input);
                };
                
                recognition.onerror = (event) => {
                    console.error('Error en reconocimiento de voz:', event.error);
                    let errorMsg = 'Error en el reconocimiento de voz';
                    
                    switch(event.error) {
                        case 'no-speech':
                            errorMsg = 'No se detectó voz. Intenta hablar más fuerte.';
                            break;
                        case 'audio-capture':
                            errorMsg = 'No se pudo acceder al micrófono.';
                            break;
                        case 'not-allowed':
                            errorMsg = 'Permisos de micrófono denegados.';
                            break;
                        case 'network':
                            errorMsg = 'Error de red durante el reconocimiento.';
                            break;
                    }
                    
                    alert(errorMsg);
                    stopVoiceRecognition();
                };
                
                recognition.onend = () => {
                    stopVoiceRecognition();
                };
                
                // Iniciar reconocimiento
                recognition.start();
                
            } catch (error) {
                console.error('Error al inicializar reconocimiento de voz:', error);
                alert('Error al acceder al reconocimiento de voz.');
            }
        }

        function stopVoiceRecognition() {
            if (recognition && isRecording) {
                recognition.stop();
                isRecording = false;
                isTranscribing = false;
                
                // Actualizar UI
                const voiceBtn = document.getElementById('voiceBtn');
                const recordingIndicator = document.getElementById('recordingIndicator');
                voiceBtn.classList.remove('recording');
                recordingIndicator.classList.remove('show');
                
                recognition = null;
            }
        }



        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        function startNewChat() {
            // Limpiar la conversación actual
            conversationId = null;
            const messagesContainer = document.getElementById('messagesContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            
            messagesContainer.innerHTML = '';
            messagesContainer.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            
            console.log('Nueva conversación iniciada');
        }

        function sendSuggestion(message) {
            const input = document.querySelector('.chat-input');
            input.value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.querySelector('.chat-input');
            const message = input.value.trim();
            
            if ((!message && !selectedFile) || isWaitingForResponse) return;
            
            // Limpiar input
            input.value = '';
            autoResize(input);
            
            // Ocultar pantalla de bienvenida y mostrar mensajes
            hideWelcomeScreen();
            
            // Preparar el mensaje a mostrar
            let displayText = message;
            if (selectedFile) {
                displayText = (message ? message + '\n\n' : '') + `📋 ${selectedFile.name}`;
            }
            
            // Mostrar mensaje del usuario
            displayMessage(displayText, 'user');
            
            // Mostrar indicador de escritura
            showTypingIndicator();
            
            try {
                isWaitingForResponse = true;
                
                // Preparar el cuerpo de la petición
                const requestBody = {
                    chatInput: message || '',
                    message: message || '',
                    userId: '{{ usuario }}',
                    sessionId: conversationId || generateSessionId(),
                    timestamp: new Date().toISOString()
                };

                // Si hay un archivo seleccionado, agregarlo al mensaje
                if (selectedFile) {
                    try {
                        const fileData = await readFileAsBase64(selectedFile);
                        requestBody.file = {
                            name: selectedFile.name,
                            type: selectedFile.type,
                            size: selectedFile.size,
                            data: fileData
                        };
                        requestBody.hasAttachment = true;
                        
                        // Agregar información del archivo al mensaje
                        const fileInfo = `\n\n[Archivo adjunto: ${selectedFile.name} (${formatFileSize(selectedFile.size)})]`;
                        requestBody.chatInput = (message || 'Archivo adjunto') + fileInfo;
                        requestBody.message = (message || 'Archivo adjunto') + fileInfo;
                        
                    } catch (fileError) {
                        console.error('Error al procesar archivo:', fileError);
                        hideTypingIndicator();
                        displayMessage('Error al procesar el archivo. Por favor intenta de nuevo.', 'bot');
                        isWaitingForResponse = false;
                        return;
                    }
                }


                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': 'Atenea-Chat/1.0',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();

                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error(`Error 500 en n8n workflow. Posibles causas:
1. El nodo AI Agent no está configurado correctamente
2. Falta configuración en Google Gemini
3. El nodo Webhook no está devolviendo respuesta
4. Error en el Structured Output Parser

Respuesta del servidor: ${responseText}`);
                    } else if (response.status === 404) {
                        throw new Error('Webhook no encontrado. Verifica que el workflow esté activo y la URL sea correcta.');
                    } else {
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}\nRespuesta: ${responseText}`);
                    }
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // Si no es JSON, asumimos que es la respuesta directa del modelo
                    data = { output: responseText };
                }
                
                // Actualizar sessionId/conversationId
                if (data.sessionId) {
                    conversationId = data.sessionId;
                } else if (data.conversationId) {
                    conversationId = data.conversationId;
                } else if (!conversationId) {
                    conversationId = generateSessionId();
                }
                
                // Ocultar indicador de escritura
                hideTypingIndicator();
                
                // Buscar la respuesta en diferentes campos posibles de n8n
                const assistantResponse = data.output ||
                                        data.response ||
                                        data.result ||
                                        data.text ||
                                        data.content ||
                                        data.answer ||
                                        data.message ||
                                        (typeof data === 'string' ? data : JSON.stringify(data, null, 2));
                
                if (assistantResponse && assistantResponse.trim()) {
                    displayMessage(assistantResponse, 'assistant');
                } else {
                    displayMessage('Recibí una respuesta pero está vacía. Verifica la configuración del workflow.', 'assistant', true);
                }
                
                // Limpiar archivo seleccionado después del envío exitoso
                if (selectedFile) {
                    removeFile();
                }
                
            } catch (error) {
                hideTypingIndicator();
                
                let errorMessage = 'Lo siento, hubo un error al procesar tu mensaje.';
                
                if (error.message.includes('500')) {
                    errorMessage = 'Error en el workflow de n8n. Revisa la configuración del AI Agent y Google Gemini.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Webhook no encontrado. ¿Está activo el workflow?';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Error CORS. Habilita CORS en el nodo Webhook de n8n.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Error de conexión. Verifica la URL del webhook.';
                }
                
                displayMessage(errorMessage, 'assistant', true);
                
                // Mostrar ayuda específica para tu workflow
                setTimeout(() => {
                    displayMessage(`� Checklist para tu workflow n8n:

✅ **Webhook Node:**
- Método: POST
- CORS habilitado
- Respuesta activada

✅ **AI Agent Node:**
- Google Gemini configurado
- Input field mapeado correctamente
- Conexión válida con la API

✅ **Message a Model Node:**
- Configurado para devolver respuesta
- Output format correcto

✅ **Structured Output Parser:**
- Schema definido
- Conexión correcta

📋 **Datos que se envían:**
\`\`\`json
{
  "chatInput": "mensaje",
  "message": "mensaje", 
  "userId": "${'{{ usuario }}'}",
  "sessionId": "id_unico"
}
\`\`\``, 'assistant');
                }, 1000);
            } finally {
                isWaitingForResponse = false;
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesContainer.style.display = 'flex';
            }
        }

        function displayMessage(content, type, isError = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            if (type === 'user') {
                avatar.textContent = '{{ usuario[0].upper() }}';
            } else {
                // Para el asistente, usar la imagen del logo
                const img = document.createElement('img');
                img.src = '{{ url_for("static", filename="images/logo2.png") }}';
                img.alt = 'Atenea';
                avatar.appendChild(img);
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = `message-content ${isError ? 'error-message' : ''}`;
            
            // Procesar contenido para archivos adjuntos
            let processedContent = content;
            if (type === 'user' && content.includes('📋')) {
                const parts = content.split('📋');
                if (parts.length > 1) {
                    const textPart = parts[0].trim();
                    const filePart = parts[1].trim();
                    
                    processedContent = textPart;
                    if (filePart) {
                        processedContent += `<div class="file-attachment">
                            <span class="file-icon">📋</span>
                            <span>${filePart}</span>
                        </div>`;
                    }
                }
            }
            
            messageContent.innerHTML = formatMessage(processedContent);
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageContent.appendChild(messageTime);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Formatear mensaje básico (puedes expandir esto para markdown, etc.)
            return content.replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            
            // Usar la imagen del logo para el avatar del asistente
            const img = document.createElement('img');
            img.src = '{{ url_for("static", filename="images/logo2.png") }}';
            img.alt = 'Atenea';
            avatar.appendChild(img);
            
            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator';
            typingContent.innerHTML = `
                <span>Atenea está escribiendo</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            messagesContainer.appendChild(typingDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Cerrar sidebar en móvil al hacer clic fuera
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.mobile-overlay').classList.remove('active');
            }
        });

        // Crear favicon circular con fondo negro
        function createBlackBackgroundFavicon() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 32;
            canvas.height = 32;
            
            // Crear un círculo negro de fondo
            ctx.fillStyle = '#000000';
            ctx.beginPath();
            ctx.arc(16, 16, 16, 0, Math.PI * 2);
            ctx.fill();
            
            // Cargar y dibujar el logo
            const img = new Image();
            img.onload = function() {
                // Crear un clipping circular para el logo
                ctx.save();
                ctx.beginPath();
                ctx.arc(16, 16, 14, 0, Math.PI * 2);
                ctx.clip();
                
                // Dibujar la imagen centrada dentro del círculo
                const size = 28;
                const x = (32 - size) / 2;
                const y = (32 - size) / 2;
                ctx.drawImage(img, x, y, size, size);
                
                ctx.restore();
                
                // Convertir a dataURL y actualizar favicon
                const faviconUrl = canvas.toDataURL('image/png');
                const favicon = document.getElementById('favicon');
                if (favicon) {
                    favicon.href = faviconUrl;
                } else {
                    const newFavicon = document.createElement('link');
                    newFavicon.rel = 'icon';
                    newFavicon.type = 'image/png';
                    newFavicon.href = faviconUrl;
                    document.head.appendChild(newFavicon);
                }
            };
            img.src = '{{ url_for("static", filename="images/logo.png") }}';
        }

        // Inicializar chat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Chat Atenea inicializado');
            console.log('Webhook URL:', WEBHOOK_URL);
            
            // Crear favicon con fondo negro
            createBlackBackgroundFavicon();
        });
    </script>
</body>
</html>