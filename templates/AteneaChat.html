<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atenea - {{ usuario }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #212121;
            color: #ececec;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: #171717;
            border-right: 1px solid #2f2f2f;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #2f2f2f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .new-chat-btn {
            background: transparent;
            border: 1px solid #2f2f2f;
            color: #ececec;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
            width: 100%;
        }

        .new-chat-btn:hover {
            background-color: #2f2f2f;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 4px;
            color: #ececec;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .chat-item:hover {
            background-color: #2f2f2f;
        }

        .chat-item.active {
            background-color: #2f2f2f;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #2f2f2f;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-menu:hover {
            background-color: #2f2f2f;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            color: #8e8ea0;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #212121;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2f2f2f;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #ececec;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn {
            background: transparent;
            border: none;
            color: #8e8ea0;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .header-btn:hover {
            background-color: #2f2f2f;
            color: #ececec;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .welcome-icon {
            width: 120px;
            height: 120px;
            background: #000000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            font-size: 32px;
            color: white;
            overflow: hidden;
            padding: 15px;
        }

        .welcome-icon img {
            border-radius: 50%;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #ececec;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: #8e8ea0;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .suggestions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            width: 100%;
            max-width: 800px;
        }

        .suggestion-card {
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .suggestion-card:hover {
            background-color: #3f3f3f;
            border-color: #4FC3F7;
        }

        .suggestion-icon {
            font-size: 20px;
            color: #4FC3F7;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #ececec;
        }

        .suggestion-desc {
            font-size: 14px;
            color: #8e8ea0;
            line-height: 1.4;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: fadeInUp 0.3s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            color: white;
        }

        .message-content {
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 16px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #4FC3F7, #2196F3);
            border-color: #4FC3F7;
            color: white;
        }

        .message-time {
            font-size: 12px;
            color: #8e8ea0;
            margin-top: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            max-width: 70%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #8e8ea0;
            border-radius: 50%;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            background-color: #4a1d1d;
            border-color: #cc4444;
            color: #ff6b6b;
        }

        /* Input Area */
        .input-area {
            padding: 24px;
            border-top: 1px solid #2f2f2f;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .chat-input {
            width: 100%;
            background-color: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 12px;
            padding: 16px 60px 16px 20px;
            color: #ececec;
            font-size: 16px;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #4FC3F7;
        }

        .chat-input::placeholder {
            color: #8e8ea0;
        }

        .send-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: #4FC3F7;
            border: none;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .send-btn:hover {
            background: #2196F3;
        }

        .send-btn:disabled {
            background: #3f3f3f;
            cursor: not-allowed;
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: #2f2f2f;
            border: 1px solid #3f3f3f;
            border-radius: 8px;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(8px);
            transition: all 0.2s;
            z-index: 1000;
            margin-bottom: 8px;
        }

        .dropdown:hover .dropdown-content {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-content a {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: #ececec;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: #3f3f3f;
        }

        .dropdown-content a:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-content a:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s;
            }

            .mobile-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .chat-header {
                padding-left: 60px;
            }

            .menu-toggle {
                position: absolute;
                left: 24px;
                background: transparent;
                border: none;
                color: #ececec;
                font-size: 18px;
                cursor: pointer;
            }

            .suggestions {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 24px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f3f;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4f4f4f;
        }
    </style>
</head>
<body>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <i class="fas fa-plus"></i>
                    Nueva conversación
                </button>
            </div>
            
            <div class="chat-history">
                <div class="chat-item active">
                    <i class="fas fa-message"></i>
                    Conversación actual
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="dropdown">
                    <div class="user-menu">
                        <div class="user-avatar">{{ usuario[0].upper() }}</div>
                        <div class="user-info">
                            <div class="user-name">{{ usuario }}</div>
                            <div class="user-email">{{ email }}</div>
                        </div>
                    </div>
                    <div class="dropdown-content">
                        <a href="/mi_perfil"><i class="fas fa-user"></i> Mi Perfil</a>
                        <a href="/logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-title">Atenea - Asistente IA</div>
                <div class="header-actions">
                    <button class="header-btn" title="Nueva conversación">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="header-btn" title="Configuración">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Atenehaz que el fionde de la imagen sea negroa Logo" style="width: 100%; height: 100%; object-fit: contain;">
                    </div>
                    <h1 class="welcome-title">¡Hola, {{ usuario }}!</h1>
                    <p class="welcome-subtitle">
                        Soy Atenea, tu asistente personal de inteligencia artificial. Puedo ayudarte con consultas sobre tu cuenta, 
                        gestión de perfil, y responder cualquier pregunta que tengas.
                    </p>
                </div>
                
                <div class="messages-container" id="messagesContainer" style="display: none;">
                    <!-- Los mensajes aparecerán aquí -->
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        class="chat-input" 
                        placeholder="Escribe tu mensaje aquí..."
                        rows="1"
                        onkeydown="handleKeyPress(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://apps.alico-sa.com/webhook/6dfbf8bb-a111-43a3-a00f-1c2d6b6379a9/chat';
        let conversationId = null;
        let isWaitingForResponse = false;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        function startNewChat() {
            // Limpiar la conversación actual
            conversationId = null;
            const messagesContainer = document.getElementById('messagesContainer');
            const welcomeScreen = document.getElementById('welcomeScreen');
            
            messagesContainer.innerHTML = '';
            messagesContainer.style.display = 'none';
            welcomeScreen.style.display = 'flex';
            
            console.log('Nueva conversación iniciada');
        }

        function sendSuggestion(message) {
            const input = document.querySelector('.chat-input');
            input.value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.querySelector('.chat-input');
            const message = input.value.trim();
            
            if (!message || isWaitingForResponse) return;
            
            // Limpiar input
            input.value = '';
            autoResize(input);
            
            // Ocultar pantalla de bienvenida y mostrar mensajes
            hideWelcomeScreen();
            
            // Mostrar mensaje del usuario
            displayMessage(message, 'user');
            
            // Mostrar indicador de escritura
            showTypingIndicator();
            
            try {
                isWaitingForResponse = true;
                
                // Formato específico para n8n workflow con AI Agent
                const requestBody = {
                    chatInput: message,
                    message: message,
                    userId: '{{ usuario }}',
                    sessionId: conversationId || generateSessionId(),
                    timestamp: new Date().toISOString()
                };
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': 'Atenea-Chat/1.0',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify(requestBody)
                });

                const responseText = await response.text();

                if (!response.ok) {
                    if (response.status === 500) {
                        throw new Error(`Error 500 en n8n workflow. Posibles causas:
1. El nodo AI Agent no está configurado correctamente
2. Falta configuración en Google Gemini
3. El nodo Webhook no está devolviendo respuesta
4. Error en el Structured Output Parser

Respuesta del servidor: ${responseText}`);
                    } else if (response.status === 404) {
                        throw new Error('Webhook no encontrado. Verifica que el workflow esté activo y la URL sea correcta.');
                    } else {
                        throw new Error(`Error HTTP ${response.status}: ${response.statusText}\nRespuesta: ${responseText}`);
                    }
                }

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // Si no es JSON, asumimos que es la respuesta directa del modelo
                    data = { output: responseText };
                }
                
                // Actualizar sessionId/conversationId
                if (data.sessionId) {
                    conversationId = data.sessionId;
                } else if (data.conversationId) {
                    conversationId = data.conversationId;
                } else if (!conversationId) {
                    conversationId = generateSessionId();
                }
                
                // Ocultar indicador de escritura
                hideTypingIndicator();
                
                // Buscar la respuesta en diferentes campos posibles de n8n
                const assistantResponse = data.output ||
                                        data.response ||
                                        data.result ||
                                        data.text ||
                                        data.content ||
                                        data.answer ||
                                        data.message ||
                                        (typeof data === 'string' ? data : JSON.stringify(data, null, 2));
                
                if (assistantResponse && assistantResponse.trim()) {
                    displayMessage(assistantResponse, 'assistant');
                } else {
                    displayMessage('Recibí una respuesta pero está vacía. Verifica la configuración del workflow.', 'assistant', true);
                }
                
            } catch (error) {
                hideTypingIndicator();
                
                let errorMessage = 'Lo siento, hubo un error al procesar tu mensaje.';
                
                if (error.message.includes('500')) {
                    errorMessage = 'Error en el workflow de n8n. Revisa la configuración del AI Agent y Google Gemini.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Webhook no encontrado. ¿Está activo el workflow?';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Error CORS. Habilita CORS en el nodo Webhook de n8n.';
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorMessage = 'Error de conexión. Verifica la URL del webhook.';
                }
                
                displayMessage(errorMessage, 'assistant', true);
                
                // Mostrar ayuda específica para tu workflow
                setTimeout(() => {
                    displayMessage(`� Checklist para tu workflow n8n:

✅ **Webhook Node:**
- Método: POST
- CORS habilitado
- Respuesta activada

✅ **AI Agent Node:**
- Google Gemini configurado
- Input field mapeado correctamente
- Conexión válida con la API

✅ **Message a Model Node:**
- Configurado para devolver respuesta
- Output format correcto

✅ **Structured Output Parser:**
- Schema definido
- Conexión correcta

📋 **Datos que se envían:**
\`\`\`json
{
  "chatInput": "mensaje",
  "message": "mensaje", 
  "userId": "${'{{ usuario }}'}",
  "sessionId": "id_unico"
}
\`\`\``, 'assistant');
                }, 1000);
            } finally {
                isWaitingForResponse = false;
            }
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (welcomeScreen.style.display !== 'none') {
                welcomeScreen.style.display = 'none';
                messagesContainer.style.display = 'flex';
            }
        }

        function displayMessage(content, type, isError = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? '{{ usuario[0].upper() }}' : 'A';
            
            const messageContent = document.createElement('div');
            messageContent.className = `message-content ${isError ? 'error-message' : ''}`;
            messageContent.innerHTML = formatMessage(content);
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = new Date().toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageContent.appendChild(messageTime);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatMessage(content) {
            // Formatear mensaje básico (puedes expandir esto para markdown, etc.)
            return content.replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'A';
            
            const typingContent = document.createElement('div');
            typingContent.className = 'typing-indicator';
            typingContent.innerHTML = `
                <span>Atenea está escribiendo</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(typingContent);
            messagesContainer.appendChild(typingDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Cerrar sidebar en móvil al hacer clic fuera
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.querySelector('.mobile-overlay').classList.remove('active');
            }
        });

        // Inicializar chat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Chat Atenea inicializado');
            console.log('Webhook URL:', WEBHOOK_URL);
        });
    </script>
</body>
</html>